function createShareLinks(t){var e=t.getShareLinks();$(".js-share-twitter").attr("href",e.twitter),$(".js-share-facebook").attr("href",e.facebook),$("#social").css("left",$("#map").width()-190+"px")}function handleShareLinks(t,e,i){var a=screen.height/2-i/2,n=screen.width/2-e/2;window.open(t,"sharer","top="+a+",left="+n+",toolbar=0,status=0,width="+e+",height="+i)}!function(t,e,i,a){function n(t,e,i){var a;return function(){var n=this,s=arguments,r=function(){a=null,i||t.apply(n,s)},o=i&&!a;clearTimeout(a),a=setTimeout(r,e),o&&t.apply(n,s)}}function s(){function i(){var t=location.hash||"#";l.run(t.slice(1))}var n,s=null,h=null;e(".description:visible").length||(e("#description-popover").popover({placement:"bottom",html:!0,content:e("#description-text").html()}),e("#description-popover").popover("show"),e("#description-popover").on("click",function(){e("#description-popover").popover("toggle")}),setTimeout(function(){e("#description-popover").popover("hide")},1e4),e(".popover-content").on("click",function(t){e("#description-popover").popover("hide")}));var l=Rlite();l.add("lat/:lat/lng/:lng/zoom/:zoom",function(t){try{var e={lat:parseFloat(t.params.lat),lng:parseFloat(t.params.lng)};o.isValidCoord(e)&&(s=e)}catch(t){}if(t.params.zoom)try{var i=parseInt(t.params.zoom,10);i>=0&&i<=18&&(h=i)}catch(t){}}),t.addEventListener("hashchange",i),i(),n=new o(document.getElementById("map"),t.firebase.database(),s,h),!s&&"geolocation"in navigator&&navigator.geolocation.getCurrentPosition(function(t){n.setCenter({lat:t.coords.latitude,lng:t.coords.longitude})}),e("body").on("click",".btn-save",function(){if(!n.isBusy())return n.saveMarker(),n._iw.setContent(n.getInfoWindowHTML()),!0}),e(".log-action").on("click",function(){n.logAction(e(this).attr("data-action"))}),n._translator=new a,n._translator.initialize().then(function(){var t=e(r.TACO_MAP.initialMessageWithPos),i=e(r.TACO_MAP.initialMessage);t=n._translator.translateElement(t),i=n._translator.translateElement(i),s?n._iw.setContent(t.html()):n._iw.setContent(i.html()),createShareLinks(n),e(n._map).on("updatedHash",function(t){createShareLinks(n)}),e("body").on(".js-share-twitter,.js-share-facebook","click",function(t){t.preventDefault();var i=e(this).attr("href");handleShareLinks(i,400,400)})}.bind(this))}var r={FIREBASE:{apiKey:"AIzaSyBqSP5M103Gk1MkvE3ANTiWoNzX1lz2B0U",authDomain:"virtual-taco-tru-1473204584057.firebaseapp.com",databaseURL:"https://virtual-taco-tru-1473204584057.firebaseio.com",storageBucket:"virtual-taco-tru-1473204584057.appspot.com"},GOOGLE_API_KEY:"AIzaSyC0xQ57bjRAv9JpC-u14Ps0DwG7EDFJAzU",TACO_MAP:{defaultCenter:{lat:38.897885,lng:-77.036508},staticMarker:{height:60,width:34,url:"images/marker_truck_blue.png"},userMarker:{height:60,width:34,url:"images/marker_truck_dkblue.png"},mcOptions:{zoomOnClick:!1,maxZoom:15,styles:[{height:34,width:60,url:"images/marker_truck_blue_plain.png",textColor:"#fece3f"}]},initialMessage:"#initial-content",initialMessageWithPos:"#initial-content-with-initial-pos",clusterCalculator:function(t,e){var i=t.length;return i>1e3&&(i=parseInt(i/100)/10+"k"),{text:i,index:0}},saveConfirmation:"#info-content",saveError:"#error-content",initialZoom:15}},o=function(e,a,n,s){this._initialPosition=n||r.TACO_MAP.defaultCenter,this._db=a,this._map=new i.maps.Map(e,{center:new i.maps.LatLng(this._initialPosition.lat,this._initialPosition.lng),zoom:s||r.TACO_MAP.initialZoom,mapTypeControl:!1,streetViewControl:!1,clickableIcons:!1}),this._mc=new t.MarkerClusterer(this._map,[],r.TACO_MAP.mcOptions),this._mc.setCalculator(r.TACO_MAP.clusterCalculator),this._iw=new i.maps.InfoWindow({maxWidth:270}),this._userMarker=new i.maps.Marker({draggable:!0,raiseOnDrag:!1,icon:{size:new i.maps.Size(r.TACO_MAP.userMarker.height,r.TACO_MAP.userMarker.width),url:r.TACO_MAP.userMarker.url},map:this._map,position:this._initialPosition,zIndex:10}),this._isInitialized=!1,this._isBusy=!1,this._init()};o.prototype._init=function(){return this.isInitialized?this:(this._iw.open(this._map,this._userMarker),this._db.ref("trucks").on("child_added",function(t){this.addMarker({lat:t.val().lat,lng:t.val().lng})}.bind(this)),i.maps.event.addListener(this._userMarker,"dragend",function(){this._updateHash(),this._map.panTo(this.getUserPosition())}.bind(this)),i.maps.event.addListener(this._map,"click",function(t){this._userMarker.setPosition(t.latLng),this._updateHash()}.bind(this)),this._map.addListener("center_changed",n(function(){this._userMarker.setPosition(this._map.getCenter()),this._updateHash()}.bind(this),100)),this._map.addListener("zoom_changed",function(){this._updateHash()}.bind(this)),this._updateHash(),this)},o.prototype._updateHash=function(){if(!("replaceState"in history))return this;e(this._map).trigger("updatedHash");var t=this.getUserPosition(),i="#/lat/"+t.lat+"/lng/"+t.lng+"/zoom/"+this._map.getZoom();return history.replaceState(null,null,i),this},o.prototype.addMarker=function(t){if(!o.isValidCoord(t))return this;var e=new i.maps.Marker({icon:r.TACO_MAP.staticMarker,position:t,zIndex:9,map:this._map});return this._mc.addMarker(e),this},o.prototype.setCenter=function(t){return o.isValidCoord(t)?(this._map.setCenter(t),this._userMarker.setPosition(t),this):this},o.prototype.logAction=function(t){var e=this._db.ref().child("logs/"+t).push().key,i={};i["/logs/"+t+"/"+e]=this.getUserPosition(),this._db.ref().update(i)},o.prototype.saveMarker=function(){this._userMarker.setAnimation(i.maps.Animation.BOUNCE),e(this._map).trigger("saveStart");var t=this._db.ref().child("trucks").push().key,a={};return a["/trucks/"+t]=this.getUserPosition(),this._map._isBusy=!0,this._db.ref().update(a).then(function(){var t=Math.pow(2,3-this._map.getZoom()),a=this.getUserPosition();this._userMarker.setAnimation(null),this._userMarker.setPosition({lat:a.lat-t,lng:a.lng-t}),this._iw.open(this._map,this._userMarker),e(".log-action").on("click",function(t){this.logAction(e(t.target).attr("data-action"))}.bind(this)),i.maps.event.addListenerOnce(this._userMarker,"dragend",function(){this._iw.setContent(e("#initial-content").html())}.bind(this)),this._map._isBusy=!1,e(this._map).trigger("saveSuccess")}.bind(this),function(){this._userMarker.setAnimation(null),this._iw.setContent(e(r.TACO_MAP.saveError).html()),this._iw.open(this._map,this._userMarker),i.maps.event.addListenerOnce(this._userMarker,"dragend",function(){this._iw.setContent(e("#initial-content").html())}.bind(this)),this._map._isBusy=!1,e(this._map).trigger("saveError")}.bind(this)),this},o.prototype.getShareLinks=function(){var e,i=encodeURIComponent(t.location.href);return this._translator&&(e=this._translator.translatePhrase("tweet-text")),e||(e="I just sponsored a virtual taco truck. You can, too. Taco trucks on every corner."),{twitter:["http://twitter.com/intent/tweet?url=",i,"&text=",encodeURIComponent(e)," &hashtags=ImWithHer,TacoTrucksOnEveryCorner"].join(""),facebook:"http://facebook.com/sharer/sharer.php?u="+i}},o.prototype.getInfoWindowShareButtons=function(){var t=this.getShareLinks(),e=['<div><a href="',t.twitter,'" class="btn btn-xs btn-secondary btn-tweet js-share-twitter log-action" ','data-action="tweet"><i class="fa fa-twitter" /></i> ','<span class="i18n-tweet">Tweet</span></a> ','<a href="'+t.facebook,'" class="btn btn-xs btn-secondary btn-share js-share-facebook log-action" ','data-action="share" target="share"><i class="fa fa-facebook-official">','</i> <span class="i18n-share">Share</span></a></div>'].join("");return e},o.prototype.getInfoWindowHTML=function(){var t=['<div class="popup-share">','<p><span class="i18n-tell-friends">Tell your friends</span>',':<br>"','<span class="i18n-tell-friends-message">',"I just sponsored a taco truck at TacoTrucks.Party",'</span>"</p>',this.getInfoWindowShareButtons(),"</p></div>"].join("");return this._translator&&(t=this._translator.translateElement(e(t)).html()),t},o.prototype.getUserPosition=function(){var t={lat:this._userMarker.getPosition().lat(),lng:this._userMarker.getPosition().lng()};return t},o.prototype.isBusy=function(){return this._isBusy},o.isValidCoord=function(t){var e=t.lat,i=t.lng;return e>=0&&e<90&&i>=-180&&i<=180},t.firebase.initializeApp(r.FIREBASE),i.load("maps","3",{other_params:"key="+r.GOOGLE_API_KEY,callback:s})}(window,jQuery,google,TacoTranslator);